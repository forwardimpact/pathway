# Basecamp — build, install, and manage the scheduler

app_name   := "fit-basecamp"
version    := "1.0.1"
plist_name := "com.fit-basecamp.scheduler"
dist_dir   := "dist"

# Detect current architecture
arch := if `uname -m` == "arm64" { "aarch64-apple-darwin" } else { "x86_64-apple-darwin" }

# Show available recipes
[doc("List all available recipes")]
default:
    @just --list

# ─── Build ────────────────────────────────────────────────────────────────────

# Compile binary for the current architecture
build:
    ./scripts/compile.sh "{{ dist_dir }}" "{{ app_name }}" "{{ arch }}"

# Compile binary for a specific target (e.g. aarch64-apple-darwin)
build-target target:
    ./scripts/compile.sh "{{ dist_dir }}" "{{ app_name }}" "{{ target }}"

# Compile binaries for both arm64 and x86_64
build-all:
    ./scripts/compile.sh "{{ dist_dir }}" "{{ app_name }}" "aarch64-apple-darwin"
    ./scripts/compile.sh "{{ dist_dir }}" "{{ app_name }}" "x86_64-apple-darwin"

# Build macOS installer package (.pkg) for the current architecture
pkg: build
    ./scripts/build-pkg.sh "{{ dist_dir }}" "{{ app_name }}" "{{ version }}" "{{ arch }}"

# Build installer packages for both architectures
pkg-all: build-all
    ./scripts/build-pkg.sh "{{ dist_dir }}" "{{ app_name }}" "{{ version }}" "aarch64-apple-darwin"
    ./scripts/build-pkg.sh "{{ dist_dir }}" "{{ app_name }}" "{{ version }}" "x86_64-apple-darwin"

# Clean build artifacts
clean:
    rm -rf "{{ dist_dir }}"

# ─── Install / Uninstall ─────────────────────────────────────────────────────

# Install locally (set up config and default KB at ~/Documents/Personal/)
install:
    ./scripts/install.sh

# Uninstall (remove binary and LaunchAgent; data at ~/Documents/Personal/ is preserved)
uninstall:
    ./scripts/uninstall.sh "{{ app_name }}" "{{ plist_name }}"

# ─── Scheduler ────────────────────────────────────────────────────────────────

# Run due tasks once and exit
run:
    deno run --allow-all scheduler.js

# Run scheduler daemon (poll every 60s)
daemon:
    deno run --allow-all scheduler.js --daemon

# Run a specific task immediately
run-task task:
    deno run --allow-all scheduler.js --run "{{ task }}"

# Show knowledge bases and task status
status:
    deno run --allow-all scheduler.js --status

# Initialize a new knowledge base at the given path
init path:
    deno run --allow-all scheduler.js --init "{{ path }}"
