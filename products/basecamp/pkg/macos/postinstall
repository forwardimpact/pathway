#!/bin/bash

# Basecamp postinstall script â€” runs as root after macOS pkg installation.
#
# Sets up per-user config and default knowledge base for the console user
# (the person who double-clicked the installer).
#
# Also removes old loose-binary install artifacts (pre-app-bundle era)
# and any LaunchAgent from previous versions.

REAL_USER=$(/usr/bin/stat -f "%Su" /dev/console)
REAL_HOME=$(/usr/bin/dscl . -read "/Users/$REAL_USER" NFSHomeDirectory | /usr/bin/awk '{print $2}')

BASECAMP_HOME="$REAL_HOME/.fit/basecamp"
DEFAULT_KB="$REAL_HOME/Documents/Personal"
APP_PATH="/Applications/Basecamp.app"

# --- Remove old installs ----------------------------------------------------

# Old LaunchAgents (pre-app-bundle)
for OLD_LABEL in "com.fit-basecamp.scheduler" "com.fit-basecamp.status-menu"; do
  OLD_PLIST="$REAL_HOME/Library/LaunchAgents/$OLD_LABEL.plist"
  if [ -f "$OLD_PLIST" ]; then
    /usr/bin/sudo -u "$REAL_USER" /usr/bin/launchctl unload "$OLD_PLIST" 2>/dev/null || true
    /bin/rm -f "$OLD_PLIST"
  fi
done

# Previous-version LaunchAgent (app-bundle era, now removed)
PLIST="$REAL_HOME/Library/LaunchAgents/com.forwardimpact.basecamp.plist"
if [ -f "$PLIST" ]; then
  /usr/bin/sudo -u "$REAL_USER" /usr/bin/launchctl unload "$PLIST" 2>/dev/null || true
  /bin/rm -f "$PLIST"
fi

# Stop any running instance so the new binary takes effect on next launch
/usr/bin/killall Basecamp 2>/dev/null || true
/usr/bin/killall fit-basecamp 2>/dev/null || true
/usr/bin/killall BasecampStatus 2>/dev/null || true
/bin/rm -f "/usr/local/bin/fit-basecamp"
/bin/rm -f "/usr/local/bin/BasecampStatus"

# Old shared resources and pkg receipt
/bin/rm -rf "/usr/local/share/fit-basecamp"
/usr/sbin/pkgutil --pkgs 2>/dev/null | /usr/bin/grep -q "com.fit-basecamp.scheduler" && {
  /usr/sbin/pkgutil --forget "com.fit-basecamp.scheduler" >/dev/null 2>&1
} || true

# --- Config home -------------------------------------------------------------

/usr/bin/sudo -u "$REAL_USER" /bin/mkdir -p "$BASECAMP_HOME/logs"

if [ ! -f "$BASECAMP_HOME/scheduler.json" ]; then
  CONFIG_SRC="$APP_PATH/Contents/Resources/config/scheduler.json"
  if [ -f "$CONFIG_SRC" ]; then
    /usr/bin/sudo -u "$REAL_USER" /bin/cp "$CONFIG_SRC" "$BASECAMP_HOME/scheduler.json"
  fi
fi

if [ ! -f "$BASECAMP_HOME/state.json" ]; then
  echo '{ "tasks": {} }' | /usr/bin/sudo -u "$REAL_USER" /usr/bin/tee "$BASECAMP_HOME/state.json" > /dev/null
fi

# --- Default knowledge base --------------------------------------------------

if [ ! -d "$DEFAULT_KB" ]; then
  SCHEDULER="$APP_PATH/Contents/MacOS/fit-basecamp"
  if [ -f "$SCHEDULER" ]; then
    /usr/bin/sudo -u "$REAL_USER" "$SCHEDULER" --init "$DEFAULT_KB" 2>/dev/null || true
  fi
fi

exit 0
